name: C++ CI with Makefile

on:
  push:
    branches: [ ci_test ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ make
        
    - name: Find and display Makefile info
      run: |
        echo "=== –ü–æ–∏—Å–∫ Makefile –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ==="
        find . -name "*akefile*" -type f | grep -v ".git" || true
        
        if [ -f "21.09.25_HW1/makefile_HW1" ]; then
          echo "‚úÖ Makefile –Ω–∞–π–¥–µ–Ω –≤ 21.09.25_HW1/"
          cd 21.09.25_HW1
          echo "=== Makefile —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ ==="
          cat makefile_HW1
          echo "=== –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–ª–∏ ==="
          make -f makefile_HW1 -qp | awk -F':' '/^[a-zA-Z0-9][^$#\/\t=]*:([^=]|$)/ {split($1,A,/ /);for(i in A)print A[i]}' | sort -u
        else
          echo "‚ùå Makefile –Ω–µ –Ω–∞–π–¥–µ–Ω"
          echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π ==="
          ls -la */ || true
          exit 1
        fi
        
    - name: Build project
      run: |
        cd 21.09.25_HW1
        if make -f makefile_HW1 -q all 2>/dev/null; then
          make -f makefile_HW1 all
        elif make -f makefile_HW1 -q main 2>/dev/null; then
          make -f makefile_HW1 main
        else
          make -f makefile_HW1
        fi
        
    - name: Run tests if exists
      run: |
        cd 21.09.25_HW1
        if make -f makefile_HW1 -q test 2>/dev/null; then
          echo "üîß –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          make -f makefile_HW1 test
        else
          echo "‚ÑπÔ∏è –¶–µ–ª—å 'test' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Makefile"
        fi
        
    - name: Clean build (optional)
      if: always()
      run: |
        cd 21.09.25_HW1
        if make -f makefile_HW1 -q clean 2>/dev/null; then
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ build..."
          make -f makefile_HW1 clean
        fi
