name: C++ CI with Makefile

on:
  push:
    branches: [ ci_test ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ make
        
    - name: Display Makefile info
      run: |
        # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ –∂–µ –∏–º—è —Ñ–∞–π–ª–∞, —á—Ç–æ –∏ –≤ –ø—Ä–æ–≤–µ—Ä–∫–µ
        if [ -f "makefile_HW1" ]; then
          echo "=== Makefile —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ ==="
          cat makefile_HW1  # ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û: –º–∞–ª–µ–Ω—å–∫–∞—è m
          echo "=== –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–ª–∏ ==="
          make -f makefile_HW1 -qp | awk -F':' '/^[a-zA-Z0-9][^$#\/\t=]*:([^=]|$)/ {split($1,A,/ /);for(i in A)print A[i]}' | sort -u
        else
          echo "‚ùå Makefile –Ω–µ –Ω–∞–π–¥–µ–Ω"
          ls -la  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û: –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –ø–æ—Å–º–æ—Ç—Ä–∏–º –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –µ—Å—Ç—å
          exit 1
        fi
        
    - name: Build project
      run: |
        # –£–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è make
        if make -f makefile_HW1 -q all 2>/dev/null; then
          make -f makefile_HW1 all
        elif make -f makefile_HW1 -q main 2>/dev/null; then
          make -f makefile_HW1 main
        else
          make -f makefile_HW1
        fi
        
    - name: Run tests if exists
      run: |
        if make -f makefile_HW1 -q test 2>/dev/null; then
          echo "üîß –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          make -f makefile_HW1 test
        else
          echo "‚ÑπÔ∏è –¶–µ–ª—å 'test' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Makefile"
        fi
        
    - name: Clean build (optional)
      if: always()
      run: |
        if make -f makefile_HW1 -q clean 2>/dev/null; then
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ build..."
          make -f makefile_HW1 clean
        fi
