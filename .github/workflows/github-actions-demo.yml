name: C++ CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ ci_test3 ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential g++ make
        
    - name: Rename makefile
      run: mv makefile_HW3 Makefile
      
    - name: Build project
      run: make
      
    - name: Run cpplint (Code style check)
      run: |
        python3 -m pip install cpplint
        cpplint --filter=-build/include_subdir,-build/header_guard Source.cpp
        
    - name: Check if executable exists
      run: |
        if [ -f "output" ]; then
          echo "Executable created successfully"
        else
          echo "No executable found - checking for other outputs"
          ls -la
        fi
        
    - name: Basic compilation test
      run: |
        g++ -o test_build Source.cpp -Wall -Wextra -std=c++17
        echo "Compilation successful"
        
  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Semgrep security scan
      uses: returntocorp/semgrep-action@v1
      with:
        config: p/cpp
