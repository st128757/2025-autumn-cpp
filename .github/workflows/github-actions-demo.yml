name: C++ CI with Makefile

on:
  push:
    branches: [ ci_test ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ make
        
    - name: Display Makefile info
      run: |
        if [ -f "Makefile" ]; then
          echo "=== Makefile ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ ==="
          cat Makefile
          echo "=== Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ñ†ĞµĞ»Ğ¸ ==="
          make -qp | awk -F':' '/^[a-zA-Z0-9][^$#\/\t=]*:([^=]|$)/ {split($1,A,/ /);for(i in A)print A[i]}' | sort -u
        else
          echo "âŒ Makefile Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
          exit 1
        fi
        
    - name: Build project
      run: |
        # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ common targets
        if make -q all 2>/dev/null; then
          make all
        elif make -q main 2>/dev/null; then
          make main
        else
          make
        fi
        
    - name: Run tests if exists
      run: |
        if make -q test 2>/dev/null; then
          echo "ğŸ”§ Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ²..."
          make test
        else
          echo "â„¹ï¸ Ğ¦ĞµĞ»ÑŒ 'test' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ° Ğ² Makefile"
        fi
        
    - name: Clean build (optional)
      if: always()
      run: |
        if make -q clean 2>/dev/null; then
          echo "ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° build..."
          make clean
        fi
